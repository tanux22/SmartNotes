name: CI/CD Pipeline for Render with Docker

on:
  push:
    branches:
      - "**" # Run on all branches

jobs:
  docker:
      name: üê≥ Build and Push Docker Images for Frontend & Backend
      runs-on: ubuntu-latest
      steps:
        - name: üì• Checkout Code
          uses: actions/checkout@v3

        # Build and push backend image
        - name: üîê Docker Login for Backend
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: üß∞ Build Docker Image for Backend
          run: |
            cd backend
            docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_BACKEND_REPO }}:${{ github.sha }} .

        - name: üöÄ Push Docker Image for Backend
          run: |
            docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_BACKEND_REPO }}:${{ github.sha }}

        # Build and push frontend image
        - name: üîê Docker Login for Frontend
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: üß∞ Build Docker Image for Frontend
          run: |
            cd frontend
            docker build \
            --build-arg VITE_BACKEND_URL=${{ secrets.VITE_BACKEND_URL }} \
            --build-arg VITE_LANGCHAIN_FASTAPI_URL=${{ secrets.VITE_LANGCHAIN_FASTAPI_URL }} \
            -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_FRONTEND_REPO }}:${{ github.sha }} .

        - name: üöÄ Push Docker Image for Frontend
          run: |
            docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_FRONTEND_REPO }}:${{ github.sha }}
