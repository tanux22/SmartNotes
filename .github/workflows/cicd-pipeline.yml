name: CI/CD Pipeline for Render with Docker

on:
  push:
    branches:
      - "**" # Run on all branches

jobs:
  docker:
      name: ğŸ³ Build and Push Docker Images for Frontend & Backend
      runs-on: ubuntu-latest
      steps:
        - name: ğŸ“¥ Checkout Code
          uses: actions/checkout@v3

        # Build and push backend image
        - name: ğŸ” Docker Login for Backend
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: ğŸ§° Build Docker Image for Backend
          run: |
            cd backend
            docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_BACKEND_REPO }}:${{ github.sha }} .

        - name: ğŸš€ Push Docker Image for Backend
          run: |
            docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_BACKEND_REPO }}:${{ github.sha }}

        # Build and push frontend image
        - name: ğŸ” Docker Login for Frontend
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: ğŸ§° Build Docker Image for Frontend
          run: |
            cd frontend
            docker build \
            --build-arg VITE_BACKEND_URL=${{ secrets.VITE_BACKEND_URL }} \
            --build-arg VITE_LANGCHAIN_FASTAPI_URL=${{ secrets.VITE_LANGCHAIN_FASTAPI_URL }} \
            -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_FRONTEND_REPO }}:${{ github.sha }} .

        - name: ğŸš€ Push Docker Image for Frontend
          run: |
            docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_FRONTEND_REPO }}:${{ github.sha }}


  deploy:
    name: ğŸš€ Deploy to Render (Frontend & Backend)
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: ğŸ”— Deploy Backend to Render
        run: |
          curl -X GET \
            "${{ secrets.RENDER_BACKEND_URL }}&imgURL=docker.io%2F${{ secrets.DOCKER_USERNAME }}%2F${{ secrets.DOCKER_BACKEND_REPO }}%3A${{ github.sha }}"

      - name: ğŸ”— Deploy Frontend to Render
        run: |
          curl -X GET \
            "${{ secrets.RENDER_FRONTEND_URL }}&imgURL=docker.io%2F${{ secrets.DOCKER_USERNAME }}%2F${{ secrets.DOCKER_FRONTEND_REPO }}%3A${{ github.sha }}"



